---
format_version: 1.1.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
trigger_map:
  - push_branch: "*"
    workflow: full_build
workflows:
  _setup:
    steps:
      - activate-ssh-key@4.0.3:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone:
          inputs:
            - clone_depth: ''
          title: Git Clone Repo
      - script:
          inputs:
            - content: |-
                #!/bin/bash

                npm cache verify

                npm install
          title: Install NPM Packages
  _unit_tests:
    speps:
      - npm:
          inputs:
            - command: test
          title: Run Unit tests
  _e2e_tests:
    steps:
      - npm:
          inputs:
            - command: install -g detox-cli
          title: Install Detox CLI
      - npm:
          inputs:
            - command: install -g react-native-cli
          title: Install React Native CLI
      - script:
          inputs:
            - content: |-
                #!/bin/bash

                brew tap wix/brew
                brew install applesimutils
          title: Install Detox Utils
      - npm:
          inputs:
            - command: run-script test-ios-release
          title: Run Detox Tests
  _deploy:
    steps:
      - install-missing-android-tools@2.3.4:
          inputs:
            - gradlew_path: "$PROJECT_LOCATION/gradlew"
      - android-build@0.9.5:
          inputs:
            - module: app
            - variant: Debug
            - project_location: "$PROJECT_LOCATION"
          title: Build Android Debug apk
      - certificate-and-profile-installer@1.10.1: {}
      - xcode-archive@2.4.18:
          inputs:
            - project_path: "$BITRISE_PROJECT_PATH"
            - scheme: "$BITRISE_SCHEME"
            - export_method: "$BITRISE_EXPORT_METHOD"
            - configuration: Debug
          title: XCode Archive
      - deploy-to-bitrise-io@1.3.19: {}
  full_build:
    before_run:
      - _setup
      - _unit_tests
      - _e2e_tests
      - _deploy
    after_run: []
  testtt:
    before_run:
      - _setup
      - _unit_tests
      - _e2e_tests
    after_run: []
app:
  envs:
    - opts:
        is_expand: false
      PROJECT_LOCATION: android
    - opts:
        is_expand: false
      MODULE: app
    - opts:
        is_expand: false
      VARIANT: _
    - opts:
        is_expand: false
      BITRISE_PROJECT_PATH: ios/RedditApp.xcodeproj
    - opts:
        is_expand: false
      BITRISE_SCHEME: Reddit
    - opts:
        is_expand: false
      BITRISE_EXPORT_METHOD: development
